/* ==========================================
 * =	Mike Pinto							=
 * =	mspkvp@github.com					=
 * =	Â©2017 tk7movespretty				=
 * ========================================== */
"use strict";function isLetter(e){return e.toLowerCase()!=e.toUpperCase()}function setLang(e){lang=parseInt(e),jap=0===lang,fetchmovelist(selected_char)}function selectChar(e){
//remove other moves
d3.select(".move-table").remove(),d3.select(".char-movelist .inner-table").html('<table class="move-table"></table>');
//de-select card
var s=char_data[selected_char].c.split(" ");d3.select("#"+s[0]).classed("selected",!1),s=char_data[selected_char=e].c.split(" "),d3.select("#"+s[0]).classed("selected",!0),d3.select("#selected-title").text(char_data[selected_char].n)}var char_data=[],ctrls_map,hits_map=[],selected_char="32",lang=1,jap=!1,prefDialog=!1,button_layouts=["STEAM","PS4","XBOX"],bl_choice=2;String.prototype.hexEncode=function(){var e,s="";for(e=0;e<this.length;e++)s+=("000"+this.charCodeAt(e).toString(16)).slice(-4);return s},String.prototype.hexDecode=function(){var e,s=this.match(/.{1,4}/g)||[],t="";for(e=0;e<s.length;e++)t+=String.fromCharCode(parseInt(s[e],16));return t};var togglePreferences=function(){prefDialog?d3.select("#preferences").style("visibility","hidden"):d3.select("#preferences").style("visibility","visible"),prefDialog=!prefDialog},changePlatform=function(e){bl_choice=e,fetchmovelist(selected_char)},importdata=function(){d3.json("./assets/data/map_hits.json",function(e,s){for(var t in s)hits_map[s[t].i]=s[t].h;d3.json("./assets/data/map_ctrls.json",function(e,s){ctrls_map=s,d3.json("./assets/data/map_chars.json",function(e,s){for(var t in s)char_data[s[t].i]={c:s[t].c,n:s[t].n};for(let e=0;e<s.length;e++){var a=s[e].c.split(" ");"11"==s[e].i&&(a=s[e].c.split("-")),d3.select(".char-menu > .inner-table > table").append("tr").html('<td class="char-card" id="'+s[e].c.split(" ")[0]+'"><img src="./assets/chars/'+a.join("").toLowerCase()+'_thumbnail.png"><p>'+s[e].c+"</p></td>"),d3.select("#"+s[e].c.split(" ")[0]).on("click",function(){fetchmovelist(s[e].i)})}var l=char_data[selected_char].c.split(" ");d3.select("#"+l[0]).classed("selected",!0),d3.select("#selected-title").text(char_data[selected_char].n),fetchmovelist(selected_char)})})})},fetchmovelist=function(e){d3.json("./assets/data/movelists/MOVELIST_"+e+".json",function(s,t){selectChar(e);var a=0;for(let s=0;s<t.moves.length;s++){
// Number + Move Name
// Special 
if(!t.moves[s].number>0){let e='<td class="move-card"><div class="move-info"><div class="move-number">&#9733;</div><div class="move-title"><div class="move-name" style="margin-bottom:5px;">'+t.moves[s].name[jap?0:1]+"</div></div></div></td>";d3.select(".move-table").append("tr").html(e);continue}a++;var l='<td class="move-card"><div class="move-info"><div class="move-number">'+t.moves[s].number+'</div><div class="move-title"><div class="move-name">'+t.moves[s].name[jap?0:1]+'</div><div class="move-hitamount">'+t.moves[s].ds.length+(t.moves[s].ds.length>1?" Hits":" Hit")+"</div></div>";
// Move String
l+='<div class="move-string">';let o=t.moves[s].command[lang].split(" ");for(let e=0;e<o.length;e++)if(/[a-z]/.test(o[e].toLowerCase()))l+='<p class="move-hint">'+o[e]+"</p>";else for(let s=0;s<o[e].length;s++)try{isLetter(ctrls_map[o[e].charAt(s)])?ctrls_map[o[e].charAt(s)]===ctrls_map[o[e].charAt(s)].toLowerCase()||"N"===ctrls_map[o[e].charAt(s)]?l+='<img class="move-arrow" src="./assets/arrow/'+ctrls_map[o[e].charAt(s)].toLowerCase()+'.svg">':l+='<img class="move-arrow" src="./assets/arrow/'+ctrls_map[o[e].charAt(s)].toLowerCase()+'p.svg">':isNaN(ctrls_map[o[e].charAt(s)].charAt(0))?">"===ctrls_map[o[e].charAt(s)]?l+='<p class="move-hint" style="color:#37ff05;font-size:20px;"><i class="fa fa-chevron-right" aria-hidden="true"></i></p>':(console.log("1. Not added: "+o[e].charAt(s)),console.log("2. Not added map: "+ctrls_map[o[e].charAt(s)])):l+='<img class="move-button" src="./assets/button/'+button_layouts[bl_choice]+"/"+ctrls_map[o[e].charAt(s)]+'.svg">'}catch(t){"("===o[e].charAt(s)||o[e].charAt(s),l+='<p class="move-hint">'+o[e].charAt(s)+"</p>"}
// Hit Levels
l+='</div><div class="move-hit-dmg"><div class="move-hitlvlstring">';for(let a=0;a<t.moves[s].at.length;a++){try{l+='<p class="mv-hitlvl hit'+hits_map[t.moves[s].at[a].l].toLowerCase()+'">'+hits_map[t.moves[s].at[a].l]+(t.moves[s].at[a].t>0?" Throw":"")+"</p>"}catch(l){throw console.log(t.moves[s].at[a].l),console.log(hits_map[t.moves[s].at[a].l]),console.log("Fighter: "+e),console.log(t.moves[s].number),l}a+1<t.moves[s].at.length&&(l+='<i class="fa fa-chevron-right" aria-hidden="true"></i>')}
// Breaks
if(t.moves[s].br.length>0){let e="";switch(t.moves[s].br[0].b){case 1:e="1";break;case 2:e="2";break;case 3:e="1/2";break;case 4:e="1+2";break;default:e=""}l+='<i class="fa fa-caret-right" aria-hidden="true"></i>',l+='<p class="mv-hitlvl">'+t.moves[s].br[0].f+"F BREAK "+e+"</p>"}l+="</div>",
// Move Damage
l+='<div class="move-dmg"><p class="mv-frames">'+t.moves[s].d+'</p><p class="mv-id">Damage</p><div class="move-hitdmg-section"><i id="dmgmove'+t.moves[s].number+'" class="fa fa-plus-square" aria-hidden="true"></i><div class="move-hitdmg">';for(let e=0;e<t.moves[s].ds.length;e++)l+=t.moves[s].ds[e].d,e+1<t.moves[s].ds.length&&(l+="+");
//Start Frames Segmented
if(l+="</div></div></div></div></div>",
// extra section
l+='<div class="move-extra"><div class="mv-section"><div class="move-special">',
// special effects
t.moves[s].b9&&(l+='<p class="spin">SPIN</p>'),t.moves[s].b8&&(l+='<p class="armor">ARMOR</p>'),t.moves[s].bB&&(l+='<p class="track">TRACK</p>'),l+="</div>",
// Move Frames
// Start F
l+='<table class="move-frames"><tr class="move-startf"><td class="mv-id">Start</td><td class="mv-frames">'+t.moves[s].s+"F</td></tr>",t.moves[s].s>0){l+='<tr class="move-startf-seg"><td>'+t.moves[s].s+"F = ";for(var c=1;c<t.moves[s].ss.length;c++)l+=t.moves[s].ss[c].s,c+1<t.moves[s].ss.length&&(l+="+");l+="</td></tr>"}
// Block F
l+='<tr class="move-blockf"><td class="mv-id">Block</td><td class="mv-frames '+(t.moves[s].blk>-1?'blkpositive">+':t.moves[s].blk<-10?'blknegative">':'blkmild">')+t.moves[s].blk+"</td></tr>",
// Hit Adv F
l+='<tr class="move-hitf"><td class="mv-id">Hit</td><td class="mv-frames">'+(t.moves[s].adv>0?"+"+t.moves[s].adv:t.moves[s].adv)+"</td></tr></table>",l+="</div>",
// ----- mv section
l+="</div></td>",d3.select(".move-table").append("tr").html(l)}for(var o=1;o<=a;o++){var i=o;d3.select("#dmgmove"+i).on("mouseenter",function(){d3.select("i#"+this.id+" + div.move-hitdmg").style("display","initial")}),d3.select("#dmgmove"+o).on("mouseleave",function(){var e=this.id;setTimeout(function(){d3.select("i#"+e+" + div.move-hitdmg").style("display","none")},3e3)})}})};